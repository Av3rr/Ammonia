<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AI Security Agent - Панель управления</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root{
            --primary: #AAAAAA;
            --secondary: #724784;
            --accent: #724784;
            --danger: #FF7F42;
            --success: #2ecc71;
            --light: #FFFFFF;
            --dark: #0C0F0A;
            --muted: #6b6b6b;
        }

        /* Reset & base */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html,body { height: 100%; }
        body {
            font-family: Inter, "Segoe UI", Tahoma, sans-serif;
            background: #F8FDEA;
            color: var(--dark);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            line-height: 1.45;
        }

        /* Layout */
        .container { display: flex; min-height: 100vh; }
        .sidebar {
            width: 72px;
            background: var(--primary);
            padding: 16px 8px;
            color: white;
            display:flex;
            align-items:flex-start;
            justify-content:center;
        }
        .sidebar .logo { text-align:center; width:100%; }
        .sidebar .logo i { font-size:22px; color: var(--accent); }

        main.main {
            flex:1;
            padding: 20px;
            overflow:auto;
        }

        .header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:16px;
            margin-bottom:18px;
            border-bottom:1px solid #e9e9ea;
            padding-bottom:12px;
        }

        .header h2 { display:flex; align-items:center; gap:10px; font-size:18px; color:var(--primary); }
        .emergency-stop {
            background: var(--danger);
            color:#fff;
            border:none;
            padding:8px 12px;
            border-radius:8px;
            cursor:pointer;
            display:inline-flex;
            gap:8px;
            align-items:center;
            font-weight:600;
        }
        .grid {
            display:grid;
            grid-template-columns: 1fr 2fr;
            gap:20px;
            align-items:start;
        }
        .card {
            background:#fff;
            border-radius:12px;
            padding:16px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
        }

        /* controls */
        label { display:block; margin-bottom:8px; color:var(--muted); font-weight:600; font-size:13px; }
        select, textarea, input[type="text"] {
            width:100%;
            padding:10px 12px;
            border-radius:8px;
            border:1px solid #e6e6e6;
            font-size:14px;
            background:#fff;
            color:var(--dark);
        }
        textarea { min-height:84px; resize:vertical; }

        .controls { display:flex; gap:10px; margin-top:12px; align-items:center; }
        .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; display:inline-flex; gap:8px; align-items:center; }
        .btn-primary { background:var(--accent); color:#fff; }
        .btn-ghost { background:transparent; border:1px solid #eee; color:var(--dark); }

        .scan-mode-selector { display:flex; gap:10px; margin-top:8px; }
        .scan-mode { flex:1; padding:10px; border-radius:8px; border:2px solid #eee; text-align:center; cursor:pointer; font-weight:600; color:var(--muted); }
        .scan-mode.active { border-color: var(--accent); background: rgba(114,71,132,0.06); color:var(--accent); }

        /* monitoring */
        .monitoring { max-height:320px; overflow:auto; margin-top:12px; display:flex; flex-direction: column; gap:8px; }
        .log-entry {
            padding:10px;
            border-left:4px solid var(--accent);
            background:#fbfbfb;
            border-radius:8px;
            font-size:13px;
            color:#333;
        }
        .log-entry.warning { border-left-color: var(--danger); background:#fff6f0; }
        .log-entry.success { border-left-color: var(--success); background:#f2fff4; }

        /* reports */
        .reports-list { margin-top:10px; display:flex; flex-direction:column; gap:8px; }
        .report-item { display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:8px; border:1px dashed #eee; background:#fff; }

        /* agent/chat */
        .agent { display:flex; flex-direction:column; min-height:640px; height:100%; }
        .agent-header { display:flex; justify-content:space-between; align-items:center; padding:12px 8px; border-bottom:1px solid #f0eff5; background:linear-gradient(0deg,#fff,#fbf9ff); border-radius:8px 8px 0 0; }
        #agent-status { display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:20px; font-weight:600; color:#333; background:transparent; }
        .chat { flex:1; padding:12px; overflow:auto; background:#f8f9fa; border-radius:8px; margin:12px 0; box-shadow: inset 0 0 6px rgba(0,0,0,0.03); display:flex; flex-direction:column; gap:10px; }
        .message { display:flex; gap:10px; align-items:flex-start; }
        .message.agent { justify-content:flex-start; }
        .message.user { justify-content:flex-end; }
        .bubble { padding:10px 12px; border-radius:14px; max-width:78%; font-size:14px; line-height:1.4; }
        .message.agent .bubble { background:#fff; border:1px solid rgba(114,71,132,0.08); color:var(--secondary); }
        .message.user .bubble { background:var(--secondary); color:#fff; }
        .avatar { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; }
        .agent-avatar { background:var(--secondary); color:#fff; }
        .user-avatar { background:var(--primary); color:#0C0F0A; }

        .input-row { display:flex; gap:8px; align-items:center; }
        #user-input { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e6e6e6; }

        .typing { font-style:italic; color:var(--secondary); padding:8px 12px; border-radius:12px; background:rgba(114,71,132,0.06); display:inline-block; }

        /* modal */
        .modal { position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:2000; }
        .modal .box { background:white; padding:16px; border-radius:10px; max-width:900px; max-height:90vh; overflow:auto; width:100%; }
        .close { background:#f3f3f3; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }

        .small { font-size:13px; color:var(--muted); }

        @media (max-width:1000px) {
            .grid { grid-template-columns: 1fr; }
            .agent { min-height:420px; }
            .sidebar { display:none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo"><i class="fas fa-robot"></i></div>
        </aside>

        <main class="main">
            <div class="header">
                <h2><i class="fas fa-shield-alt"></i> Панель управления Pentest Agent</h2>
                <div>
                    <button class="emergency-stop" id="emergency-btn" title="Экстренная остановка">
                        <i class="fas fa-stop-circle"></i> ЭКСТРЕННАЯ ОСТАНОВКА
                    </button>
                </div>
            </div>

            <div class="grid">
                <!-- Left column -->
                <div>
                    <div class="card">
                        <h3 style="margin-bottom:10px"><i class="fas fa-cogs"></i> Сканер и запуск агента</h3>

                        <label for="model-select">Модель</label>
                        <select id="model-select"></select>

                        <label for="task-input" style="margin-top:10px">Задача (инструкции для агента)</label>
                        <textarea id="task-input" placeholder="Опишите задачу, например: 'Проведи разведку сети 10.0.0.0/24 и сформируй план'"></textarea>

                        <div class="controls">
                            <button class="btn btn-primary" id="start-agent-btn"><i class="fas fa-play"></i> Запустить агента</button>
                            <button class="btn btn-ghost" id="refresh-models"><i class="fas fa-sync"></i> Обновить модели</button>
                        </div>

                        <div style="margin-top:12px">
                            <label>Режим сканирования</label>
                            <div class="scan-mode-selector">
                                <div class="scan-mode active" data-mode="black">Чёрный ящик</div>
                                <div class="scan-mode" data-mode="gray">Серый ящик</div>
                                <div class="scan-mode" data-mode="white">Белый ящик</div>
                            </div>
                        </div>

                        <div style="margin-top:12px">
                            <label>Сценарий атаки</label>
                            <select id="attack-scenario">
                                <option value="ddos">DDoS атака</option>
                                <option value="sql">SQL инъекция</option>
                                <option value="xss">XSS атака</option>
                                <option value="credential">Подбор учетных данных</option>
                                <option value="recon">Сетевая разведка</option>
                            </select>
                        </div>
                    </div>

                    <div class="card" style="margin-top:14px">
                        <h3><i class="fas fa-list"></i> Мониторинг операций</h3>
                        <div class="monitoring" id="monitoring-logs" aria-live="polite"></div>
                        <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-ghost" id="refresh-agents"><i class="fas fa-users"></i> Список агентов</button>
                            <select id="agents-list" style="flex:1"></select>
                            <button class="btn btn-ghost" id="get-agent-state" title="Показать состояние">Состояние</button>
                        </div>
                    </div>

                    <div class="card" style="margin-top:14px">
                        <h3><i class="fas fa-file-alt"></i> Отчёты (reports)</h3>
                        <div class="small" id="reports-hint" style="margin-bottom:8px">Попытка получить список файлов /reports — проверьте, что backend/Nginx выставляет эту папку по HTTP.</div>
                        <div class="reports-list" id="reports-list"></div>
                        <div style="margin-top:8px">
                            <button class="btn btn-ghost" id="refresh-reports"><i class="fas fa-sync"></i> Обновить список</button>
                        </div>
                    </div>
                </div>

                <!-- Right column (agent/chat) -->
                <div class="card agent">
                    <div class="agent-header">
                        <div style="display:flex;align-items:center;gap:12px">
                            <h3 style="margin:0"><i class="fas fa-robot"></i> ИИ-агент</h3>
                            <div id="current-agent-id" class="small" style="opacity:0.9"></div>
                        </div>
                        <div id="agent-status"><span class="status-indicator" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--success);margin-right:8px"></span>Не запущен</div>
                    </div>

                    <div class="chat" id="chat-container" role="log" aria-live="polite">
                        <div class="message agent">
                            <div class="avatar agent-avatar"><i class="fas fa-robot"></i></div>
                            <div class="bubble">Здравствуйте! Я Pentes Agent. Введите задачу и нажмите «Запустить агента».</div>
                        </div>
                    </div>

                    <div style="margin-top:6px">
                        <div id="typing-indicator" class="typing" style="display:none">Pentes Agent печатает...</div>
                    </div>

                    <div style="margin-top:8px" class="input-row">
                        <input id="user-input" type="text" placeholder="Отправить уточнение агенту / задать вопрос..." />
                        <button id="send-btn" class="btn btn-primary" title="Отправить"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for report preview -->
    <div id="modal" class="modal" aria-hidden="true">
        <div class="box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <strong id="modal-title"></strong>
                <div style="display:flex;gap:8px">
                    <button id="download-report" class="close">Скачать</button>
                    <button id="close-modal" class="close">Закрыть</button>
                </div>
            </div>
            <div id="modal-body" style="white-space:pre-wrap"></div>
        </div>
    </div>

    <script>
        // ============================
        // Configuration
        // ============================
        // If frontend and backend are same origin (nginx proxy), leave ''.
        // Otherwise set API_BASE to the backend origin like 'http://localhost:8010'
        const API_BASE = ''; 

        // State
        let currentAgentId = null;
        let waitingForClarification = false;
        let streamingAbortController = null;
        let modelList = [];

        // DOM refs
        const modelSelect = document.getElementById('model-select');
        const startBtn = document.getElementById('start-agent-btn');
        const taskInput = document.getElementById('task-input');
        const chatContainer = document.getElementById('chat-container');
        const typingIndicator = document.getElementById('typing-indicator');
        const sendBtn = document.getElementById('send-btn');
        const userInput = document.getElementById('user-input');
        const monitoringLogs = document.getElementById('monitoring-logs');
        const agentsListSelect = document.getElementById('agents-list');
        const refreshAgentsBtn = document.getElementById('refresh-agents');
        const getAgentStateBtn = document.getElementById('get-agent-state');
        const currentAgentIdEl = document.getElementById('current-agent-id');
        const agentStatusEl = document.getElementById('agent-status');
        const emergencyBtn = document.getElementById('emergency-btn');
        const reportsListEl = document.getElementById('reports-list');
        const refreshReportsBtn = document.getElementById('refresh-reports');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal');
        const downloadReportBtn = document.getElementById('download-report');

        // ============================
        // UI helpers
        // ============================
        function addLog(message, type = 'info') {
            const el = document.createElement('div');
            el.className = 'log-entry ' + (type === 'warning' ? 'warning' : type === 'success' ? 'success' : '');
            const t = new Date().toLocaleTimeString();
            el.innerHTML = `<div class="small">${t}</div><div>${escapeHtml(message)}</div>`;
            monitoringLogs.appendChild(el);
            monitoringLogs.scrollTop = monitoringLogs.scrollHeight;
        }

        function appendUserMessage(text) {
            const m = document.createElement('div'); m.className = 'message user';
            const bubble = document.createElement('div'); bubble.className = 'bubble';
            bubble.textContent = text;
            const avatar = document.createElement('div'); avatar.className = 'avatar user-avatar'; avatar.innerHTML = '<i class="fas fa-user"></i>';
            m.appendChild(bubble); m.appendChild(avatar);
            chatContainer.appendChild(m);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function appendAgentMessage(text) {
            const m = document.createElement('div'); m.className = 'message agent';
            const avatar = document.createElement('div'); avatar.className = 'avatar agent-avatar'; avatar.innerHTML = '<i class="fas fa-robot"></i>';
            const bubble = document.createElement('div'); bubble.className = 'bubble';
            bubble.textContent = text;
            m.appendChild(avatar); m.appendChild(bubble);
            chatContainer.appendChild(m);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function renderProgressiveAgentText(text) {
            const lastAgent = Array.from(chatContainer.querySelectorAll('.message.agent')).pop();
            if (lastAgent) {
                const bubble = lastAgent.querySelector('.bubble');
                if (bubble) bubble.textContent = text;
            } else {
                appendAgentMessage(text);
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function setAgentStatus(text, color = 'var(--success)') {
            agentStatusEl.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};margin-right:8px"></span>${escapeHtml(text)}`;
        }

        function escapeHtml(unsafe) {
            return String(unsafe).replace(/[&<"'>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
        }

        // ============================
        // Models & Agents
        // ============================
        async function fetchModels() {
            modelSelect.innerHTML = '<option>Загрузка...</option>';
            try {
                const r = await fetch(`${API_BASE}/v1/models`);
                if (!r.ok) throw new Error(`status ${r.status}`);
                const j = await r.json();
                modelList = (j.data || []).map(m => m.id || m);
                modelSelect.innerHTML = '';
                modelList.forEach(m => {
                    const o = document.createElement('option'); o.value = m; o.textContent = m; modelSelect.appendChild(o);
                });
                addLog('Модели загружены', 'success');
            } catch (err) {
                modelSelect.innerHTML = '<option value="pentest_agent">pentest_agent (по умолчанию)</option>';
                addLog('Не удалось получить список моделей: ' + err.message, 'warning');
            }
        }

        async function fetchAgentsList() {
            try {
                const r = await fetch(`${API_BASE}/agents`);
                if (!r.ok) throw new Error(`status ${r.status}`);
                const j = await r.json();
                const list = j.agents || [];
                agentsListSelect.innerHTML = '';
                const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='— выбрать —'; agentsListSelect.appendChild(emptyOpt);
                list.forEach(a => {
                    const o = document.createElement('option'); o.value = a.agent_id; o.textContent = `${a.agent_id} — ${a.task} (${a.state})`;
                    agentsListSelect.appendChild(o);
                });
                addLog('Список агентов обновлён', 'success');
            } catch (err) {
                addLog('Ошибка при получении списка агентов: ' + err.message, 'warning');
            }
        }

        // ============================
        // Streaming helpers
        // ============================
        async function streamResponse(response, handleChunk) {
            // handleChunk: (jsonChunk) => void
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buffer = '';
            typingIndicator.style.display = 'inline-block';
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });

                    // split into SSE-like parts
                    const parts = buffer.split('\n\n');
                    buffer = parts.pop(); // leftover

                    for (const p of parts) {
                        const lines = p.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                        for (const line of lines) {
                            if (!line.startsWith('data:')) continue;
                            const payloadText = line.slice(5).trim();
                            if (payloadText === '[DONE]') {
                                // finished event
                                continue;
                            }
                            try {
                                const chunk = JSON.parse(payloadText);
                                await handleChunk(chunk);
                            } catch (e) {
                                console.warn('failed parse chunk', e, payloadText);
                            }
                        }
                    }
                }
            } finally {
                typingIndicator.style.display = 'none';
            }
        }

        // ============================
        // Start agent
        // ============================
        async function startAgent() {
            const model = modelSelect.value || 'pentest_agent';
            const task = (taskInput.value || '').trim();
            if (!task) { alert('Опишите задачу для агента.'); return; }

            // clear chat and show starting message
            chatContainer.innerHTML = '';
            appendAgentMessage('Запуск агента...');

            const payload = { model, messages: [{ role:'user', content: task }], stream: true };

            // abort old stream if any
            if (streamingAbortController) {
                try { streamingAbortController.abort(); } catch(e){}
            }
            streamingAbortController = new AbortController();

            addLog(`Запрос на запуск агента (${model}) отправлен`, 'info');

            let resp;
            try {
                resp = await fetch(`${API_BASE}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: streamingAbortController.signal
                });
            } catch (err) {
                addLog('Ошибка соединения: ' + err.message, 'warning');
                appendAgentMessage('Не удалось связаться с сервером.');
                return;
            }

            if (!resp.ok) {
                const txt = await resp.text().catch(()=>`status ${resp.status}`);
                addLog('Ошибка от сервера: ' + txt, 'warning');
                appendAgentMessage('Ошибка запуска агента: ' + txt);
                return;
            }

            // Save agent id header if present
            const id = resp.headers.get('x-agent-id') || resp.headers.get('X-Agent-ID');
            const usedModel = resp.headers.get('x-agent-model') || resp.headers.get('X-Agent-Model') || model;
            if (id) {
                currentAgentId = id;
                currentAgentIdEl.textContent = id;
                waitingForClarification = false;
                addLog('Новый агент создан: ' + id, 'success');
                setAgentStatus('Запущен — ' + usedModel);
            } else {
                currentAgentId = null;
                currentAgentIdEl.textContent = '';
            }

            // Streaming: handle incremental chunks
            let accumulated = '';
            await streamResponse(resp, async (chunk) => {
                // chunk is an object; typical shape: { choices: [ { delta: { content: "..." } } ] }
                // also backend may include flags like need_clarification
                if (chunk.need_clarification === true) {
                    waitingForClarification = true;
                    appendAgentMessage('Агент запрашивает уточнение...');
                    return;
                }

                const delta = chunk.choices && chunk.choices[0] && chunk.choices[0].delta;
                if (delta && typeof delta.content === 'string') {
                    accumulated += delta.content;
                    renderProgressiveAgentText(accumulated);
                } else if (chunk.choices && chunk.choices[0] && chunk.choices[0].message && chunk.choices[0].message.content) {
                    accumulated += chunk.choices[0].message.content;
                    renderProgressiveAgentText(accumulated);
                }
            });

            addLog('Стрим от агента завершён', 'success');
            // refresh agents list/state
            await fetchAgentsList();
        }

        // ============================
        // Send clarification (correct endpoint)
        // ============================
        async function sendClarification(text) {
            if (!currentAgentId) {
                appendAgentMessage('Нет активного агента для уточнений.');
                return;
            }

            appendUserMessage(text);

            addLog('Отправка уточнения агенту: ' + currentAgentId, 'info');

            try {
                const resp = await fetch(`${API_BASE}/agents/${encodeURIComponent(currentAgentId)}/provide_clarification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clarifications: text })
                });

                if (!resp.ok) {
                    const err = await resp.text().catch(()=>`status ${resp.status}`);
                    addLog('Ошибка уточнения: ' + err, 'warning');
                    appendAgentMessage('Ошибка уточнения: ' + err);
                    return;
                }

                // stream clarification response
                let accumulated = '';
                await streamResponse(resp, async (chunk) => {
                    const delta = chunk.choices && chunk.choices[0] && chunk.choices[0].delta;
                    if (delta && typeof delta.content === 'string') {
                        accumulated += delta.content;
                        renderProgressiveAgentText(accumulated);
                    } else if (chunk.choices && chunk.choices[0] && chunk.choices[0].message && chunk.choices[0].message.content) {
                        accumulated += chunk.choices[0].message.content;
                        renderProgressiveAgentText(accumulated);
                    }
                    // if backend sets need_clarification again, UI will keep waiting
                    if (chunk.need_clarification === true) {
                        waitingForClarification = true;
                        appendAgentMessage('Агент запрашивает дополнительное уточнение...');
                    } else {
                        waitingForClarification = false;
                    }
                });

                addLog('Уточнение обработано', 'success');
                await fetchAgentState(currentAgentId);

            } catch (err) {
                addLog('Ошибка отправки уточнения: ' + err.message, 'warning');
            }
        }

        // Send a message from user input:
        async function sendUserMessage() {
            const txt = (userInput.value || '').trim();
            if (!txt) return;
            userInput.value = '';

            // if agent is waiting for clarification, send it to dedicated endpoint
            if (waitingForClarification && currentAgentId) {
                await sendClarification(txt);
                return;
            }

            // otherwise treat as a new quick task or forward to main task area
            // here we create a short new agent request by setting taskInput and starting agent
            if (!taskInput.value || taskInput.value.trim() === '') {
                taskInput.value = txt;
                await startAgent();
            } else {
                // if there is existing task text, prefer sending as clarification to running agent if exists
                if (currentAgentId) {
                    await sendClarification(txt);
                } else {
                    taskInput.value = txt;
                    await startAgent();
                }
            }
        }

        // ============================
        // Agent state
        // ============================
        async function fetchAgentState(agentId) {
            if (!agentId) return;
            try {
                const r = await fetch(`${API_BASE}/agents/${encodeURIComponent(agentId)}/state`);
                if (!r.ok) throw new Error(`status ${r.status}`);
                const j = await r.json();
                addLog(`Состояние агента ${agentId}: ${j.state} (итерация ${j.iteration ?? 'N/A'})`, 'info');
                setAgentStatus(`Агент ${j.state}`, j.state === 'researching' ? 'orange' : (j.state === 'completed' ? 'var(--success)' : 'var(--danger)'));
                return j;
            } catch (err) {
                addLog('Не удалось получить состояние агента: ' + err.message, 'warning');
            }
        }

        // ============================
        // Emergency stop (best-effort)
        // ============================
        async function emergencyStop() {
            if (!currentAgentId) {
                addLog('Нет активного агента для остановки', 'warning');
                alert('Нет активного агента. Для принудительной остановки добавьте server-side endpoint /agents/{id}/terminate.');
                return;
            }

            if (!confirm('Подтвердите отправку экстренного уведомления агенту (soft stop).')) return;
            addLog('Попытка экстренной остановки агента ' + currentAgentId, 'warning');

            try {
                const r = await fetch(`${API_BASE}/agents/${encodeURIComponent(currentAgentId)}/provide_clarification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clarifications: 'EMERGENCY_STOP' })
                });
                if (!r.ok) {
                    const t = await r.text().catch(()=>`status ${r.status}`);
                    addLog('Экстренная остановка не поддерживается сервером: ' + t, 'warning');
                    alert('Сервер не поддерживает экстренную остановку (нет endpoint).');
                    return;
                }
                addLog('Экстренное сообщение отправлено', 'success');
                setAgentStatus('Попытка остановки', 'var(--danger)');
            } catch (err) {
                addLog('Ошибка экстренной остановки: ' + err.message, 'danger');
            }
        }

        // ============================
        // Reports listing & preview
        // ============================
        async function fetchReportsList() {
            reportsListEl.innerHTML = '<div class="small">Загрузка...</div>';
            try {
                const r = await fetch(`${API_BASE}/reports`);
                if (!r.ok) {
                    reportsListEl.innerHTML = `<div class="small">Сервер вернул ${r.status} при попытке получить /reports</div>`;
                    addLog('Не удалось получить /reports: ' + r.status, 'warning');
                    return;
                }
                const arr = await r.json();
                if (!Array.isArray(arr)) {
                    reportsListEl.innerHTML = `<div class="small">Неверный формат от /reports</div>`;
                    return;
                }
                reportsListEl.innerHTML = '';
                if (arr.length === 0) {
                    reportsListEl.innerHTML = '<div class="small">Отчётов не найдено</div>';
                    return;
                }
                arr.forEach(fn => {
                    const row = document.createElement('div'); row.className = 'report-item';
                    const left = document.createElement('div'); left.textContent = fn;
                    const right = document.createElement('div');
                    const openBtn = document.createElement('button'); openBtn.className='btn btn-ghost'; openBtn.textContent='Открыть';
                    openBtn.addEventListener('click', ()=> openReport(fn));
                    right.appendChild(openBtn);
                    row.appendChild(left); row.appendChild(right);
                    reportsListEl.appendChild(row);
                });
                addLog('Список отчётов обновлён', 'success');
            } catch (err) {
                reportsListEl.innerHTML = `<div class="small">Ошибка: ${escapeHtml(err.message)}</div>`;
                addLog('Ошибка получения отчётов: ' + err.message, 'warning');
            }
        }

        async function openReport(filename) {
            const url = `${API_BASE}/reports/${encodeURIComponent(filename)}`;
            modalTitle.textContent = filename;
            modalBody.textContent = 'Загрузка...';
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden','false');
            downloadReportBtn.onclick = () => { window.open(url, '_blank'); };
            try {
                const r = await fetch(url);
                if (!r.ok) {
                    modalBody.textContent = `Не удалось получить файл: ${r.status}`;
                    return;
                }
                const md = await r.text();
                if (window.marked) {
                    modalBody.innerHTML = window.marked.parse(md);
                } else {
                    // basic fallback rendering
                    const html = md
                      .replace(/^### (.*$)/gim,'<h3>$1</h3>')
                      .replace(/^## (.*$)/gim,'<h2>$1</h2>')
                      .replace(/^# (.*$)/gim,'<h1>$1</h1>')
                      .replace(/(^|\n)```([^\n]*)\n([\s\S]*?)```/g, (m, p1, p2, code) => `<pre><code>${escapeHtml(code)}</code></pre>`)
                      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
                      .replace(/\*(.*?)\*/g,'<em>$1</em>')
                      .replace(/\n/g,'<br/>');
                    modalBody.innerHTML = html;
                }
            } catch (err) {
                modalBody.textContent = 'Ошибка: ' + err.message;
            }
        }

        // ============================
        // Event bindings & init
        // ============================
        startBtn.addEventListener('click', startAgent);
        refreshAgentsBtn.addEventListener('click', fetchAgentsList);
        document.getElementById('refresh-models').addEventListener('click', fetchModels);
        sendBtn.addEventListener('click', sendUserMessage);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendUserMessage(); });
        getAgentStateBtn.addEventListener('click', () => {
            const id = agentsListSelect.value;
            if (id) fetchAgentState(id);
            else alert('Выберите агента в списке');
        });
        emergencyBtn.addEventListener('click', emergencyStop);
        refreshReportsBtn.addEventListener('click', fetchReportsList);
        closeModalBtn.addEventListener('click', () => { modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); modalBody.innerHTML = ''; });
        modal.addEventListener('click', (e) => { if (e.target === modal) { modal.style.display='none'; modal.setAttribute('aria-hidden','true'); modalBody.innerHTML=''; } });

        // scan-mode click handlers (persist attempt)
        document.querySelectorAll('.scan-mode').forEach(el => el.addEventListener('click', () => {
            document.querySelectorAll('.scan-mode').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            const mode = el.dataset.mode;
            addLog('Режим сканирования: ' + (el.textContent || mode), 'info');
            // best-effort persist (optional)
            fetch(`${API_BASE}/api/scan/set-mode`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ mode, timestamp: new Date().toISOString() })
            }).then(r => {
                if (r.ok) addLog('Режим синхронизирован с бэкендом', 'success');
            }).catch(()=>{/* ignore */});
        }));

        // initial load
        (async function init(){
            await fetchModels();
            await fetchAgentsList();
            await fetchReportsList();
            addLog('Интерфейс загружен', 'success');
            setAgentStatus('Не запущен', 'var(--muted)');
        })();

        // expose for quick dev introspection
        window.__pentes_ui = { startAgent, fetchModels, fetchAgentsList, fetchReportsList, fetchAgentState, sendClarification };

    </script>

    <!-- marked for nicer markdown preview (optional) -->
    <script>
        (function(){
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
            s.onload = ()=>console.log('marked loaded');
            s.onerror = ()=>console.log('marked failed to load');
            document.head.appendChild(s);
        })();
    </script>
</body>
</html>
