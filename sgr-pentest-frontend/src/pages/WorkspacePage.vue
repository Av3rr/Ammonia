<template>
  <div class="workspace-page">
    <!-- Header with model selector -->
    <div class="workspace-page__header">
      <button
        :class="[
          'workspace-page__new-chat-btn',
          { 'workspace-page__new-chat-btn--highlighted': isAgentCompleted },
        ]"
        @click="handleNewChat"
        :disabled="isStreaming"
      >
        –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
      </button>
      <h1 class="workspace-page__title">SGR Pentest Agent</h1>
      <div class="workspace-page__model-selector">
        <SelectAgent />
      </div>
    </div>

    <!-- Show chat if we have messages -->
    <div v-if="hasMessages" class="workspace-page__chat">
      <ChatContainer
        :is-agent-completed="isAgentCompleted"
        @send="handleSendMessage"
        @retry="handleRetryMessage"
      />
    </div>

    <!-- Show welcome screen if no messages -->
    <div v-else class="workspace-page__welcome">
      <div class="welcome-content">
        <div class="welcome-icon">ü§ñ</div>
        <h2 class="welcome-title">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ–Ω—Ç–µ—Å—Ç-–∞–≥–µ–Ω—Ç</h2>
        <p class="welcome-subtitle">–£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª—å –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ "—á–µ—Ä–Ω—ã–π —è—â–∏–∫" –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ JSON –¥–ª—è "—Å–µ—Ä–æ–≥–æ" –∏–ª–∏ "–±–µ–ª–æ–≥–æ" "—è—â–∏–∫–∞".</p>

        <div class="examples">
          <div class="example">
            <h3 class="example-title">–ü—Ä–∏–º–µ—Ä 1: –ß–µ—Ä–Ω—ã–π —è—â–∏–∫ (—Ç–æ–ª—å–∫–æ —Ü–µ–ª—å)</h3>
            <pre><code>192.168.0.101</code></pre>
          </div>
          <div class="example">
            <h3 class="example-title">–ü—Ä–∏–º–µ—Ä 2: –°–µ—Ä—ã–π —è—â–∏–∫ (—Ü–µ–ª—å –∏ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)</h3>
            <pre><code>{
  "task": "–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–µ–Ω—Ç–µ—Å—Ç 192.168.0.101",
  "knowledge": {
    "mode": "gray_box",
    "credentials": [
      {"service": "web", "url": "http://192.168.0.101/login", "username": "admin", "password": "password123"}
    ]
  }
}</code></pre>
          </div>
        </div>
      </div>
    </div>

    <div class="workspace-page__input">
      <MessageSender
        ref="messageSenderRef"
        :is-streaming="isStreaming"
        :disabled="!currentAgent"
        @send="handleSendMessage"
      />
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { MessageSender } from '@/widgets/MessageSender'
import { ChatContainer } from '@/widgets/ChatContainer'
import { SelectAgent } from '@/features/select-agent'
import { useChatStore, useAgentsStore } from '@/shared/stores'
import type { ChatMessageExtended } from '@/shared/stores'

const chatStore = useChatStore()
const agentsStore = useAgentsStore()

const messageSenderRef = ref<InstanceType<typeof MessageSender> | null>(null)

const currentAgent = computed(() => agentsStore.currentAgent)
const isStreaming = computed(() => chatStore.isStreaming)
const hasMessages = computed(() => chatStore.currentMessages.length > 0)
const isAgentCompleted = computed(() => chatStore.currentSession?.state === 'completed')

const handleSendMessage = async (message: string) => {
  if (!message.trim()) return;

  if (hasMessages.value) {
    // Continue existing chat
    const agentId = chatStore.currentSession?.agentId;
    if (!agentId) { console.error('No agentId found'); return; }

    if (chatStore.needsClarification) {
      chatStore.addUserMessage(message); // Add user response first
      await chatStore.provideClarificationWithStreaming(agentId, message);
    } else {
      await chatStore.continueChatConversation(agentId, message);
    }
  } else {
    // Start new chat
    if (!currentAgent.value) { console.error('No agent selected'); return; }
    await chatStore.initializeChat(currentAgent.value);
    await chatStore.sendMessage(message, currentAgent.value);
  }
}

const handleRetryMessage = async (message: ChatMessageExtended) => {
  await chatStore.retryStreaming(message.id, currentAgent.value);
}

const handleNewChat = async () => {
  chatStore.clearCurrentSession();
  await chatStore.initializeChat(currentAgent.value);
}

onMounted(async () => {
  chatStore.clearCurrentSession();
  await agentsStore.initializeAgents();
})
</script>

<style scoped lang="scss">
.workspace-page { display: flex; flex-direction: column; height: 100vh; background: var(--bg-2-4-gray-1); }
.workspace-page__header { flex-shrink: 0; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 20px; padding: 12px 24px; border-bottom: 1px solid #e5e7eb; background: white; }
.workspace-page__new-chat-btn { justify-self: start; padding: 8px 16px; background: white; border: 1px solid #d1d5db; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; &:hover:not(:disabled) { background: #f9fafb; } &:disabled { opacity: 0.5; } }
.workspace-page__new-chat-btn--highlighted { background: #10b981; color: white; border-color: #10b981; }
.workspace-page__title { font-size: 18px; font-weight: 600; margin: 0; text-align: center; }
.workspace-page__model-selector { justify-self: end; }
.workspace-page__chat { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.workspace-page__welcome { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; }
.welcome-icon { font-size: 48px; margin-bottom: 16px; }
.welcome-title { font-size: 24px; font-weight: 600; margin: 0 0 8px 0; }
.welcome-subtitle { font-size: 16px; color: #6b7280; margin: 0; max-width: 500px; }
.workspace-page__input { flex-shrink: 0; background: var(--bg-2-4-gray-1); padding: 16px 0; }

.examples {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  max-width: 800px;
  margin: 32px auto 0 auto;
  text-align: left;
}
.example-title {
  font-size: 14px;
  font-weight: 600;
  margin: 0 0 8px 0;
  color: #4b5563;
}
.example pre {
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  font-family: 'Courier New', Courier, monospace;
  font-size: 13px;
  white-space: pre-wrap;
  word-break: break-all;
}
@media (max-width: 768px) {
  .examples { grid-template-columns: 1fr; }
}
</style>