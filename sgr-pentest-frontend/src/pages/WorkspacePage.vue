<template>
  <div class="workspace-page">
    <div class="workspace-page__header">
      <button class="workspace-page__new-chat-btn" @click="handleNewChat" :disabled="isStreaming">
        + Новый сеанс
      </button>
      <div class="workspace-page__model-selector">
        <SelectAgent />
      </div>
    </div>

    <div v-if="hasMessages" class="workspace-page__chat">
      <ChatContainer :is-agent-completed="isAgentCompleted" @send="handleSendMessage" @retry="handleRetryMessage" />
    </div>

    <div v-else class="workspace-page__welcome">
      <div class="welcome-content">
        <img src="/logo.svg" alt="Agent Logo" class="welcome-icon" />
        <h2 class="welcome-title">Автоматизированный пентест-агент</h2>
        <p class="welcome-subtitle">
          Укажите цель для начала сканирования в режиме "черный ящик"<br />
          или используйте JSON для "серого" или "белого" ящика.
        </p>
        <div class="examples">
          <div class="example">
            <h3 class="example-title">Пример 1: Черный ящик (только цель)</h3>
            <pre><code>192.168.0.101</code></pre>
          </div>
          <div class="example">
            <h3 class="example-title">Пример 2: Серый ящик (цель и известные данные)</h3>
            <pre><code>{
  "task": "Провести пентест 192.168.0.101",
  "knowledge": {
    "mode": "gray_box",
    "credentials": [
      {"service": "web", "url": "http://192.168.0.101/login", "username": "admin", "password": "password123"}
    ]
  }
}</code></pre>
          </div>
        </div>
      </div>
    </div>

    <div class="workspace-page__input">
      <MessageSender :is-streaming="isStreaming" :disabled="!currentAgent" @send="handleSendMessage" />
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { MessageSender } from '@/widgets/MessageSender';
import { ChatContainer } from '@/widgets/ChatContainer';
import { SelectAgent } from '@/features/select-agent';
import { useChatStore, useAgentsStore } from '@/shared/stores';
import type { ChatMessageExtended } from '@/shared/stores';

const chatStore = useChatStore();
const agentsStore = useAgentsStore();
const messageSenderRef = ref<InstanceType<typeof MessageSender> | null>(null);
const currentAgent = computed(() => agentsStore.currentAgent);
const isStreaming = computed(() => chatStore.isStreaming);
const hasMessages = computed(() => chatStore.currentMessages.length > 0);
const isAgentCompleted = computed(() => chatStore.currentSession?.state === 'completed');

const handleSendMessage = async (message: string) => {
  if (!message.trim()) return;
  if (hasMessages.value) {
    const agentId = chatStore.currentSession?.agentId;
    if (!agentId) { console.error('No agentId found'); return; }
    if (chatStore.needsClarification) {
      chatStore.addUserMessage(message);
      await chatStore.provideClarificationWithStreaming(agentId, message);
    } else {
      await chatStore.continueChatConversation(agentId, message);
    }
  } else {
    if (!currentAgent.value) { console.error('No agent selected'); return; }
    await chatStore.initializeChat(currentAgent.value);
    await chatStore.sendMessage(message, currentAgent.value);
  }
};

const handleRetryMessage = async (message: ChatMessageExtended) => {
  await chatStore.retryStreaming(message.id, currentAgent.value);
};

const handleNewChat = async () => {
  chatStore.clearCurrentSession();
  await chatStore.initializeChat(currentAgent.value);
};

onMounted(async () => {
  chatStore.clearCurrentSession();
  await agentsStore.initializeAgents();
});
</script>

<style scoped lang="scss">
.workspace-page { display: flex; flex-direction: column; height: 100vh; }
.workspace-page__header {
  flex-shrink: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 24px;
  border-bottom: 1px solid var(--brut-border);
}
.workspace-page__chat { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.workspace-page__welcome {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  text-align: center;
}
.welcome-icon {
  width: 80px;
  height: 80px;
  margin-bottom: 24px;
}
.welcome-title {
  font-size: 28px;
  font-weight: 600;
  margin: 0 0 16px 0;
  letter-spacing: 1px;
}
.welcome-subtitle {
  font-size: 16px;
  color: var(--brut-text-dim);
  margin: 0;
  line-height: 1.5;
  max-width: 600px;
}
.workspace-page__input {
  flex-shrink: 0;
  padding: 16px 0;
  border-top: 1px solid var(--brut-border);
}
.examples {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  width: 100%;
  max-width: 900px;
  margin: 40px auto 0 auto;
  text-align: left;
}
.example-title {
  font-size: 14px;
  font-weight: 500;
  margin: 0 0 12px 0;
  color: var(--brut-text-dim);
  text-transform: uppercase;
}
.example pre {
  background: var(--brut-bg-tertiary);
  border: 1px solid var(--brut-border);
  padding: 16px;
  height: 100%;
  font-size: 13px;
  white-space: pre-wrap;
  word-break: break-all;
}
@media (max-width: 768px) {
  .examples { grid-template-columns: 1fr; }
}
</style>