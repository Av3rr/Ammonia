import logging
import pandas as pd
from typing import List, Dict, Any, Optional

logger = logging.getLogger(__name__)

FSTEC_DATA_PATH = "/app/data/vullist.xlsx"

class FSTECService:
    _instance: Optional["FSTECService"] = None
    _data: List[Dict[str, Any]] = []

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(FSTECService, cls).__new__(cls)
            cls._instance._load_data()
        return cls._instance

    def _load_data(self):
        try:
            logger.info(f"Загрузка базы данных уязвимостей ФСТЭК из {FSTEC_DATA_PATH}...")
            df = pd.read_excel(FSTEC_DATA_PATH, header=2)

            df.columns = [
                'identifier', 'name', 'description', 'vendor', 'software_name',
                'software_version', 'software_type', 'os_platform', 'fix_date',
                'cvss2', 'cvss3', 'severity', 'exploit_status', 'fix_status',
                'source', 'cwe', 'cve', 'other_ids', 'notes'
            ]

            df = df.where(pd.notnull(df), None)
            self._data = df.to_dict('records')
            logger.info(f"Успешно загружено {len(self._data)} записей из БДУ ФСТЭК.")

        except FileNotFoundError:
            logger.error(f"Файл {FSTEC_DATA_PATH} не найден. Функционал поиска по БДУ ФСТЭК будет недоступен.")
        except Exception as e:
            logger.error(f"Ошибка при загрузке и парсинге vullist.xlsx: {e}", exc_info=True)

    def search(self, query: str, limit: int = 10) -> List[Dict[str, Any]]:
        if not self._data:
            return [{"error": "База данных ФСТЭК не загружена."}]

        query_lower = query.lower()
        results = []

        for record in self._data:
            if len(results) >= limit:
                break

            software_name = str(record.get('software_name', '')).lower()
            description = str(record.get('description', '')).lower()
            vendor = str(record.get('vendor', '')).lower()

            if query_lower in software_name or query_lower in description or query_lower in vendor:
                results.append(record)

        return results