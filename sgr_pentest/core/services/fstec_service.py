import logging
import pandas as pd
from typing import List, Dict, Any, Optional

logger = logging.getLogger(__name__)

FSTEC_DATA_PATH = "/app/data/vullist.xlsx"

class FSTECService:
    _instance: Optional["FSTECService"] = None
    _data: List[Dict[str, Any]] = []

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(FSTECService, cls).__new__(cls)
            cls._instance._load_data()
        return cls._instance

    def _load_data(self):
        try:
            logger.info(f"Загрузка базы данных уязвимостей ФСТЭК из {FSTEC_DATA_PATH}...")
            df = pd.read_excel(FSTEC_DATA_PATH, header=2)

            column_mapping = {
                'Идентификатор': 'identifier',
                'Наименование уязвимости': 'name',
                'Описание уязвимости': 'description',
                'Вендор': 'vendor',
                'Название ПО': 'software_name',
                'Версия ПО': 'software_version',
                'Тип ПО': 'software_type',
                'Платформа': 'os_platform',
                'Дата выявления': 'fix_date',
                'Оценка опасности (CVSS 2.0)': 'cvss2',
                'Оценка опасности (CVSS 3.0)': 'cvss3',
                'Уровень опасности уязвимости': 'severity',
                'Наличие эксплойта': 'exploit_status',
                'Статус уязвимости': 'fix_status',
                'Информация об устранении': 'source',
                'Тип ошибки CWE': 'cwe',
                'Идентификаторы других систем описаний уязвимостей': 'cve',
                'Прочая информация': 'other_ids',
                'Примечание': 'notes'
            }

            df.rename(columns=column_mapping, inplace=True)

            required_columns = [col for col in column_mapping.values() if col in df.columns]
            df = df[required_columns]

            df = df.where(pd.notnull(df), None)
            self._data = df.to_dict('records')
            logger.info(f"Успешно загружено и обработано {len(self._data)} записей из БДУ ФСТЭК.")
        except FileNotFoundError:
            logger.error(f"Файл {FSTEC_DATA_PATH} не найден. Функционал поиска по БДУ ФСТЭК будет недоступен.")
        except Exception as e:
            logger.error(f"Ошибка при загрузке и парсинге vullist.xlsx: {e}", exc_info=True)

    def search(self, query: str, limit: int = 10) -> List[Dict[str, Any]]:
        if not self._data:
            return [{"error": "База данных ФСТЭК не загружена."}]

        query_lower = query.lower()
        results = []

        for record in self._data:
            if len(results) >= limit:
                break

            software_name = str(record.get('software_name', '')).lower()
            description = str(record.get('description', '')).lower()
            vendor = str(record.get('vendor', '')).lower()

            if query_lower in software_name or query_lower in description or query_lower in vendor:
                results.append(record)

        return results