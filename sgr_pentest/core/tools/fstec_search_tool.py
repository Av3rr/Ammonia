from __future__ import annotations
import json
import logging
from typing import TYPE_CHECKING, ClassVar

from pydantic import Field

from sgr_pentest.core.base_tool import BaseTool
from sgr_pentest.core.services.fstec_service import FSTECService

if TYPE_CHECKING:
    from sgr_pentest.core.models import ResearchContext

logger = logging.getLogger(__name__)

class FSTECSearchTool(BaseTool):
    """
    Выполняет поиск уязвимостей в локальной базе данных БДУ ФСТЭК России.
    Используй этот инструмент для проверки программного обеспечения, обнаруженного
    на целевых системах, на наличие уязвимостей.
    Это особенно важно для оценки соответствия требованиям регуляторов.
    """
    tool_name: ClassVar[str] = "fstecsearch"

    reasoning: str = Field(
        description="Объяснение, почему необходимо выполнить поиск в БДУ ФСТЭК."
    )
    query: str = Field(
        description="Название программного обеспечения для поиска (например, 'nginx', 'PostgreSQL 12', 'Microsoft Windows Server 2019')."
    )

    async def __call__(self, context: ResearchContext) -> str:
        """
        Выполняет поиск в FSTECService и возвращает результат в виде JSON.
        """
        logger.info(f"FSTECSearchTool: поиск по запросу '{self.query}'")

        service = FSTECService()
        results = service.search(self.query)

        if not results:
            return json.dumps({"status": "not_found", "message": "Уязвимости по данному запросу не найдены в БДУ ФСТЭК."})

        return json.dumps(results, indent=2, ensure_ascii=False)