from __future__ import annotations
import socket
import json
import logging
from typing import TYPE_CHECKING, ClassVar

from pydantic import Field
from sgr_pentest.core.base_tool import BaseTool

if TYPE_CHECKING:
    from sgr_pentest.core.models import ResearchContext

logger = logging.getLogger(__name__)

class GetLocalIPTool(BaseTool):
    """
    Определяет локальный IP-адрес машины, на которой запущен агент.
    Этот IP-адрес следует использовать в качестве LHOST для reverse shell'ов
    и других payload'ов, требующих обратного подключения от цели.
    Инструмент не принимает никаких аргументов.
    """
    tool_name: ClassVar[str] = "getlocalip"

    reasoning: str = Field(
        description="Причина, по которой необходимо определить свой локальный IP-адрес (обычно для настройки LHOST)."
    )

    async def __call__(self, context: ResearchContext) -> str:
        """
        Определяет IP-адрес и возвращает его в формате JSON.
        """
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.settimeout(0)
            s.connect(('8.8.8.8', 1))
            local_ip = s.getsockname()[0]
            s.close()

            logger.info(f"Успешно определен локальный IP-адрес: {local_ip}")
            result = {"local_ip": local_ip}

            context.sources["agent_local_ip"] = result

            return json.dumps(result, indent=2)

        except Exception as e:
            logger.error(f"Не удалось определить локальный IP-адрес: {e}", exc_info=True)
            return json.dumps({"status": "error", "message": str(e)})
