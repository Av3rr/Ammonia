from __future__ import annotations

from typing import TYPE_CHECKING, Optional, Dict, Any

from pydantic import Field

from sgr_pentest.core.base_tool import BaseTool

if TYPE_CHECKING:
    from sgr_pentest.core.models import ResearchContext


class GeneratePlanTool(BaseTool):
    """Generate research plan.

    Useful to split complex request into manageable steps.
    """

    reasoning: str = Field(description="Justification for research approach")
    research_goal: str = Field(description="Primary research objective")
    initial_knowledge: Optional[Dict[str, Any]] = Field(
        default=None,
        description="Initial data provided by the operator (credentials, tokens, etc.). This field is for information only; the plan should be built considering this data."
    )
    planned_steps: list[str] = Field(description="List of planned steps based on the goal and initial knowledge", min_length=3, max_length=4)
    search_strategies: list[str] = Field(description="Information search strategies", min_length=2, max_length=3)

    async def __call__(self, context: ResearchContext) -> str:
        context.sources["initial_plan"] = self.model_dump()
        return self.model_dump_json(
            indent=2,
            exclude={
                "reasoning",
            },
        )
