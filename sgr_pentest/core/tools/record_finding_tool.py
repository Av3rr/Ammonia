from __future__ import annotations
import json
import logging
from typing import TYPE_CHECKING, ClassVar, Literal

from pydantic import Field

from sgr_pentest.core.base_tool import BaseTool
from sgr_pentest.core.models import Finding

if TYPE_CHECKING:
    from sgr_pentest.core.models import ResearchContext

logger = logging.getLogger(__name__)

class RecordFindingTool(BaseTool):
    """
    Фиксирует обнаруженную уязвимость или важную находку.
    ИСПОЛЬЗУЙ ЭТОТ ИНСТРУМЕНТ НЕМЕДЛЕННО после того, как другой инструмент
    (например, nmap, ffuf, searchsploit, hydra) обнаружил что-то важное.
    """
    tool_name: ClassVar[str] = "recordfinding"

    reasoning: str = Field(
        description="Краткое описание того, ЧТО было найдено и ПОЧЕМУ это важно."
    )
    description: str = Field(
        description="Детальное описание уязвимости. Что это, где найдено, как влияет на безопасность."
    )
    severity: Literal["Critical", "High", "Medium", "Low", "Informational"] = Field(
        description="Оценка критичности уязвимости."
    )
    evidence: str = Field(
        description="ДОКАЗАТЕЛЬСТВО. Скопируй сюда СЫРОЙ ВЫВОД (stdout) инструмента, который нашел уязвимость."
    )
    recommendation: str = Field(
        description="Практическая рекомендация по устранению уязвимости."
    )

    async def __call__(self, context: ResearchContext) -> str:
        """
        Создает объект Finding и добавляет его в контекст исследования.
        """
        logger.info(f"Фиксация новой находки: {self.description[:50]}... Критичность: {self.severity}")

        finding = Finding(
            description=self.description,
            severity=self.severity,
            evidence=self.evidence,
            recommendation=self.recommendation,
        )

        context.findings.append(finding)

        return json.dumps({
            "status": "success",
            "message": "Находка успешно зафиксирована.",
            "total_findings": len(context.findings)
        })