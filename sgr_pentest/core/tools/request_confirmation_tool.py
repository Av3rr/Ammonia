from __future__ import annotations
import json
import logging
from typing import TYPE_CHECKING, ClassVar, List

from pydantic import Field
from sgr_pentest.core.base_tool import BaseTool

if TYPE_CHECKING:
    from sgr_pentest.core.models import ResearchContext

logger = logging.getLogger(__name__)

class RequestConfirmationTool(BaseTool):
    """
    Приостанавливает выполнение и запрашивает подтверждение у оператора
    перед выполнением потенциально опасного или деструктивного действия.
    НИКОГДА не выполняй опасные действия без предварительного вызова этого инструмента.
    """
    tool_name: ClassVar[str] = "requestconfirmation"

    reasoning: str = Field(
        description="Краткое объяснение, почему это действие необходимо выполнить."
    )
    action_description: str = Field(
        description="Четкое и однозначное описание действия, на которое запрашивается разрешение. Например: 'Запустить эксплойт ms17_010_eternalblue на цель 192.168.1.10'."
    )
    potential_risks: List[str] = Field(
        description="Список потенциальных рисков, связанных с этим действием (например, 'Может привести к отказу в обслуживании целевой системы').",
        min_length=1
    )

    async def __call__(self, context: ResearchContext) -> str:
        """
        Возвращает JSON-структуру с запросом на подтверждение.
        Агент будет ждать ответа от пользователя.
        """
        logger.info(f"Запрос подтверждения у оператора: {self.action_description}")

        return json.dumps({
            "action": "request_confirmation",
            "description": self.action_description,
            "risks": self.potential_risks
        }, indent=2, ensure_ascii=False)